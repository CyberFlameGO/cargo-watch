#!/usr/bin/env bash

tag=$1
target=$2

if [[ -z "$tag" ]]; then
    echo Tag is needed
    exit 1
fi

if [[ -z "$target" ]]; then
    echo Target is needed
    exit 1
fi


cargo build --target $target --release

ext=""
if [[ "$target" =~ *windows* ]]; then
    ext=".exe"
fi

project="cargo-watch"
build_dir=$(mktemp -d 2>/dev/null || mktemp -d -t tmp)
out_dir=$(pwd)
name="$project-$tag-$target"
mkdir "$build_dir/$name"

cp target/$target/release/$project$ext "$build_dir/$name/"
cp LICENSE "$build_dir/$name/"

pushd $build_dir
if [[ -z "$ext" ]]; then
    # assume empty ext is linux/mac/unix
    strip "$name/$project"
    tar cvf "$out_dir/$name.tar" "$name"
    popd
    xz -f9 "$name.tar"
else
    # and otherwise is windows
    choco install 7zip
    7z a -tzip -mx9 "$out_dir/$name.zip" "$name"
    popd
fi

if [[ "$target" == "x86_64-unknown-linux-gnu" ]]; then
    mkdir -p "$build_dir/deb/$name"
    pushd "$build_dir/deb/$name"

    mkdir -p DEBIAN usr/bin
    cp "../../$name/$project" usr/bin/
    cat <<CONTROL > DEBIAN/control
Package: $project
Version: ${tag/v/}
Architecture: amd64
Maintainer: FÃ©lix Saparelli <aur@passcod.name>
Installed-Size: $(du -d1 usr | tail -n1 | cut -d\t -f1)
Homepage: https://github.com/passcod/$project
Description: Watches over your Cargo project's source.
 Cargo Watch watches over your project's source for changes, and runs Cargo commands when they occur.
CONTROL
	cd ..
	fakeroot dpkg -b "$name"
	mv "$name.deb" "$out_dir/"
	popd
fi

